#
# Copyright (C) 2006 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#
# $Id$

include $(TOPDIR)/rules.mk

PKG_NAME:=ettercap
PKG_VERSION:=NG-0.7.3
PKG_RELEASE:=0

PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.gz
PKG_SOURCE_URL:=@SF/ettercap
PKG_MD5SUM:=28fb15cd024162c55249888fe1b97820
PKG_CAT:=zcat

PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)-$(PKG_VERSION)
PKG_INSTALL_DIR:=$(PKG_BUILD_DIR)/ipkg-install

include $(INCLUDE_DIR)/package.mk

define Package/ettercap
  SECTION:=net
  CATEGORY:=Network
  DEPENDS:=+libpcap +libnet1 +libopenssl +libpcre +libiconv +libncurses +libltdl
  TITLE:=Ettercap is a suite for man in the middle attacks on LAN.
  DESCRIPTION:=\
  	It features sniffing of live connections, content filtering on the fly \\\
  	and many other interesting tricks.\\\
  	It supports active and passive dissection of many protocols (even \\\
  	ciphered ones) and includes many feature for network and host analysis.
  URL:=http://ettercap.sourceforge.net
endef

define Package/ettercap/conffiles
/etc/etter.conf
endef

define Build/Prepare
	$(call Build/Prepare/Default)
	# remove default optimization flags set by configure
	$(SED) 's,DEBUG_FLAGS=.*,DEBUG_FLAGS=,g' $(PKG_BUILD_DIR)/configure
endef

define Build/Configure
	$(call Build/Configure/Default, \
		--with-libpcap="$(STAGING_DIR)/usr" \
		--with-libnet="$(STAGING_DIR)/usr/lib/libnet-1.1.x" \
		--with-openssl="$(STAGING_DIR)/usr" \
		--with-libpcre="$(STAGING_DIR)/usr" \
		--with-iconv="$(STAGING_DIR)/usr/lib/libiconv" \
		--with-libncurses="$(STAGING_DIR)/usr" \
		--disable-gtk \
		--disable-debug \
		, \
		LDFLAGS="$$$$LDFLAGS -L$(STAGING_DIR)/usr/lib/libiconv/lib" \
	)
endef

define Build/Compile
	$(MAKE) -C $(PKG_BUILD_DIR) \
		DESTDIR="$(PKG_INSTALL_DIR)" \
		all install
endef

define Package/ettercap/install
	install -d -m0755 $(1)/etc
	$(CP) $(PKG_INSTALL_DIR)/etc/etter.conf $(1)/etc/
	install -d -m0755 $(1)/usr/bin
	$(CP) $(PKG_INSTALL_DIR)/usr/bin/etter{cap,filter,log} $(1)/usr/bin/
	install -d -m0755 $(1)/usr/lib/ettercap
	$(CP) $(PKG_INSTALL_DIR)/usr/lib/ettercap/*.so $(1)/usr/lib/ettercap/
	install -d -m0755 $(1)/usr/share/ettercap
	$(CP) $(PKG_INSTALL_DIR)/usr/share/ettercap/* $(1)/usr/share/ettercap/
endef

$(eval $(call BuildPackage,ettercap))
